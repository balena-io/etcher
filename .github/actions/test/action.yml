---
name: test release
# https://github.com/product-os/flowzone/tree/master/.github/actions
inputs:
  json:
    description: 'JSON stringified object containing all the inputs from the calling workflow'
    required: true
  secrets:
    description: 'JSON stringified object containing all the secrets from the calling workflow'
    required: true

  # --- custom environment
  NODE_VERSION:
    type: string
    default: '20.10'
  VERBOSE:
    type: string
    default: 'true'

runs:
  # https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
  using: 'composite'
  steps:
    # https://github.com/actions/setup-node#caching-global-packages-data
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ inputs.NODE_VERSION }}
        cache: npm

    - name: Install host dependencies
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo apt-get update && sudo apt-get install -y --no-install-recommends xvfb libudev-dev
        cat < package.json | jq -r '.hostDependencies[][]' - | \
          xargs -L1 echo | sed 's/|//g' | xargs -L1 \
          sudo apt-get --ignore-missing install || true

    - name: Install host dependencies
      if: runner.os == 'macOS'
      # FIXME: Python 3.12 dropped distutils that node-gyp depends upon.
      # This is a temporary workaround to make the job use Python 3.11 until
      # we update to npm 10+.
      uses: actions/setup-python@d27e3f3d7c64b4bbf8e4abfb9b63b83e846e0435 # v4
      with:
        python-version: '3.11'

    - name: Setup Virtual Drive on MacOS
      if: runner.os == 'macOS'
      shell: bash
      run: |
        hdiutil create -size 4096m -layout NONE -o virtual_test_disk.dmg
        virtual_path=$(hdiutil attach -nomount virtual_test_disk.dmg | awk '{print $1}')
        echo "TARGET_DRIVE=${virtual_path}" >> $GITHUB_ENV
        echo "ETCHER_INCLUDE_VIRTUAL_DRIVES=1" >> $GITHUB_ENV

    - name: Setup Virtual Drive on Windows
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Get the current directory
        $currentDirectory = Get-Location

        # Define the filename of the virtual disk
        $vdiskFilename = "virtual_test_disk.vhd"

        # Create the full path for the virtual disk
        $vdiskPath = Join-Path -Path $currentDirectory -ChildPath $vdiskFilename
        $vdiskSize = 4096  # Size in MB

        # Create and attach the virtual disk using DiskPart
        $diskpartScript = @"
          create vdisk file="$vdiskPath" maximum=$vdiskSize type=fixed
          select vdisk file="$vdiskPath"
          attach vdisk
          exit
        "@

        Invoke-Expression "echo '$diskpartScript' | diskpart"

        # Refresh the disk information
        Update-HostStorageCache

        # Get the number of the new disk based on the vdisk path and size
        $disk = Get-Disk | Where-Object {
            $_.OperationalStatus -eq 'Online' -and
            $_.Size -eq ($vdiskSize * 1MB)
        }

        # If multiple disks match, further filter by VHD path if possible (requires PowerShell 5.1 or later)
        if ($disk.Count -gt 1) {
            $disk = $disk | Where-Object { $_.Path -eq $vdiskPath }
        }

        $diskNumber = $disk.Number

        # Initialize the disk and create a single partition that uses the entire disk, assign drive letter Z
        Initialize-Disk -Number $diskNumber -PartitionStyle MBR

        New-Partition -DiskNumber $diskNumber -UseMaximumSize -AssignDriveLetter
        Get-Partition -DiskNumber $diskNumber | Set-Partition -NewDriveLetter Z

        # Output the details of the new drive
        Write-Output "New virtual disk created and accessible at drive letter: Z"

        echo "TARGET_DRIVE=Microsoft Virtual Disk" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Setup Virtual Drive on Linux
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y nbdkit nbd-client
        sudo modprobe nbd
        sudo nbdkit memory 4G
        sudo nbd-client localhost /dev/nbd0
        dmsg | grep nbd
        echo "TARGET_DRIVE=${/dev/nbd0}" >> $GITHUB_ENV

    - name: Test release
      shell: bash
      run: |
        # Build and Test release

        ## FIXME: causes issues with `xxhash` which tries to load a debug build which doens't exist and cannot be compiled
        # if [[ '${{ inputs.VERBOSE }}' =~ on|On|Yes|yes|true|True ]]; then
        #   export DEBUG='electron-forge:*,sidecar'
        # fi

        npm ci

        # as the shrinkwrap might have been done on mac/linux, this is ensure the package is there for windows
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          npm i -D winusb-driver-generator
        fi

        npm run lint

        # tests requires the app to already be built
        npm run package

        # download the test source
        wget -q -O ${{ env.TEST_SOURCE_FILE }} ${{ env.TEST_SOURCE_URL }}
        # E2E tests can't input the administrative password, therefore the tests need to run as root
        sudo \
          TARGET_DRIVE=${{ env.TARGET_DRIVE }} \
          ETCHER_INCLUDE_VIRTUAL_DRIVES=1 \
          TEST_SOURCE_FILE: $(pwd)/${{ env.TEST_SOURCE_FILE }} \
          TEST_SOURCE_URL: ${{ env.TEST_SOURCE_URL }} \
          npm run wdio:ci

      env:
        # https://www.electronjs.org/docs/latest/api/environment-variables
        ELECTRON_NO_ATTACH_CONSOLE: 'true'
        TEST_SOURCE_URL: 'https://api.balena-cloud.com/download?deviceType=raspberrypi4-64&version=5.2.8&fileType=.zip'
        TEST_SOURCE_FILE: 'raspberrypi4-64-5.2.8-v16.1.10.img.zip'

    - name: Compress custom source
      if: runner.os != 'Windows'
      shell: bash
      run: tar -acf ${{ runner.temp }}/custom.tgz .

    - name: Compress custom source
      if: runner.os == 'Windows'
      shell: pwsh
      run: C:\"Program Files"\Git\usr\bin\tar.exe --force-local -acf ${{ runner.temp }}\custom.tgz .

    - name: Upload custom artifact
      uses: actions/upload-artifact@v4
      with:
        name: custom-${{ github.event.pull_request.head.sha || github.event.head_commit.id }}-${{ runner.os }}-${{ runner.arch }}
        path: ${{ runner.temp }}/custom.tgz
        retention-days: 1
